<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.104.3"><meta name=description content="Velociraptor features some advanced forensics capabilities, but traditionally only works on live endpoints. In recent releases it is now also possible to use Velociraptor on dead disk images.
"><link rel=icon href=/images/favicon.png type=image/png><title>Dead disk Forensics :: Velociraptor - Digging deeper!</title><link href=/css/nucleus.css?1666623087 rel=stylesheet><link href=/css/fontawesome-all.min.css?1666623087 rel=stylesheet><link href=/css/featherlight.min.css?1666623087 rel=stylesheet><link href=/css/perfect-scrollbar.min.css?1666623087 rel=stylesheet><link href=/css/auto-complete.css?1666623087 rel=stylesheet><link href=/css/theme.css?1666623087 rel=stylesheet><link href=/css/tabs.css?1666623087 rel=stylesheet><link href=/css/hugo-theme.css?1666623087 rel=stylesheet><link href=/css/theme-mine.css?1666623087 rel=stylesheet><link href=/css/dark.css?1666623087 rel=stylesheet><link href=/css/syntax.css?1666623087 rel=stylesheet><link href=/css/light.css?1666623087 rel=stylesheet><link href=/css/hljs.css?1666623087 rel=stylesheet><link href=https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css?1666623087 rel=stylesheet><script src=/js/jquery-3.3.1.min.js?1666623087></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style><script async src="https://www.googletagmanager.com/gtag/js?id=G-QYH72LMYCS"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-QYH72LMYCS",{anonymize_ip:!1})}</script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-QYH72LMYCS","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script>
<script></script></head><body data-url=/blog/2022/2022-03-22-deaddisk/><nav id=sidebar><div id=header-wrapper><div id=header><script>function darkmode(){$("body").addClass("dark").removeClass("light"),document.cookie="theme=darkmode;path=/"}function lightmode(){$("body").removeClass("dark").addClass("light"),document.cookie="theme=lightmode;path=/"}const regex=new RegExp("theme=darkmode");regex.test(document.cookie)?darkmode():lightmode()</script><div class="btn btn-default ThemeSelector darkmode" onclick=darkmode()><i class="fas fa-moon"></i></div><div class="btn btn-default ThemeSelector lightmode" onclick=lightmode()><i class="fas fa-sun"></i></div><a href=https://docs.velociraptor.app/><img src=https://docs.velociraptor.app//images/logo.svg></a></div></div><div class=highlightable><ul class=topics><li data-nav-id=https://docs.velociraptor.app/docs/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/><i class="fas fa-book-reader"></i>Documentation</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/overview/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/overview/>Velociraptor Overview</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/overview/history/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/history/>History</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/overview/support/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/overview/support/>Support Policy</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/deployment/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/deployment/>Deployment</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/deployment/self-signed/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/self-signed/>Self-Signed SSL</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/deployment/cloud/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/deployment/cloud/>Cloud Deployment</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/deployment/cloud/multifrontend/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/cloud/multifrontend/>Multi-Frontend</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/deployment/clients/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/clients/>Deploying Clients</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/deployment/rbac/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/rbac/>Users and Roles</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/deployment/resources/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/resources/>Performance</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/deployment/troubleshooting/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/deployment/troubleshooting/>Troubleshooting</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/gui/>The Admin GUI</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/gui/clients/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/clients/>Inspecting clients</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/vfs/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/vfs/>The VFS</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/artifacts/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/artifacts/>Artifacts</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/gui/hunting/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/gui/hunting/>Hunting</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/vql/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/vql/>VQL Fundamentals</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/vql/notebooks/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/notebooks/>Notebooks</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/vql/artifacts/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/artifacts/>Artifacts</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/vql/events/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/vql/events/>Event Queries</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/forensic/>Forensic Analysis</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/forensic/filesystem/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/filesystem/>Searching Filenames</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/searching/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/searching/>Searching Content</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/ntfs/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/ntfs/>NTFS Analysis</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/binary/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/binary/>Binary parsing</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/evidence_of_execution/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/evidence_of_execution/>Evidence Of Execution</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/event_logs/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/event_logs/>Event Logs</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/forensic/volatile/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/forensic/volatile/>Volatile State</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/docs/offline_triage/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/offline_triage/>Triage and acquisition</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/client_monitoring/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/client_monitoring/>Client Monitoring</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/extending_vql/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/extending_vql/>Extending VQL</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/server_automation/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/docs/server_automation/>Server Automation</a></div><ul><li data-nav-id=https://docs.velociraptor.app/docs/server_automation/server_api/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/server_automation/server_api/>Server API</a></div></li><li data-nav-id=https://docs.velociraptor.app/docs/server_automation/server_monitoring/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/docs/server_automation/server_monitoring/>Server Monitoring</a></div></li></ul></li></ul></li><hr><li data-nav-id=https://docs.velociraptor.app/vql_reference/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/vql_reference/><i class="fas fa-book"></i>VQL Reference</a></div><ul><li data-nav-id=https://docs.velociraptor.app/vql_reference/basic/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/basic/>Basic VQL</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/linux/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/linux/>Linux Specific</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/windows/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/windows/>Windows Specific</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/parsers/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/parsers/>Parsers</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/server/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/server/>Server Side</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/plugin/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/plugin/>Client Side</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/event/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/event/>Event Plugins</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/experimental/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/experimental/>Experimental</a></div></li><li data-nav-id=https://docs.velociraptor.app/vql_reference/misc/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/vql_reference/misc/>Misc</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/training/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/training/><i class="fas fa-graduation-cap"></i>Training</a></div></li><li data-nav-id=https://docs.velociraptor.app/blog/ class="dd-item parent haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/blog/><i class="fas fa-newspaper"></i>Blog</a></div></li><li data-nav-id=https://docs.velociraptor.app/presentations/ class="dd-item haschildren"><div><i class="fa fa-angle-right fa-sm category-icon"></i>
<a href=/presentations/><i class="fas fa-chalkboard-teacher"></i>Presentations</a></div><ul><li data-nav-id=https://docs.velociraptor.app/presentations/2022_linuxconf_au/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2022_linuxconf_au/>Linux Conf Au 2022</a></div></li><li data-nav-id=https://docs.velociraptor.app/presentations/2022_auscert/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2022_auscert/>Auscert 2022</a></div></li><li data-nav-id=https://docs.velociraptor.app/presentations/2022_dfrws_us/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2022_dfrws_us/>DFRWS US 2022</a></div></li><li data-nav-id=https://docs.velociraptor.app/presentations/2022_tech_user_group_cbr/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2022_tech_user_group_cbr/>Tech Users Group 2022</a></div></li><li data-nav-id=https://docs.velociraptor.app/presentations/2022_sans_summit/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2022_sans_summit/>SANS Summit 2022</a></div></li><li data-nav-id=https://docs.velociraptor.app/presentations/2022_velocon/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2022_velocon/>Velocon 2022</a></div></li><li data-nav-id=https://docs.velociraptor.app/presentations/2022_dfrws_apac/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/presentations/2022_dfrws_apac/>DFRWS APAC 2022</a></div></li></ul></li><li data-nav-id=https://docs.velociraptor.app/exchange/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/exchange/><i class="fas fa-code"></i>Artifact Exchange</a></div></li><li data-nav-id=https://docs.velociraptor.app/artifact_references/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/artifact_references/><i class="fas fa-book"></i>Artifact Reference</a></div></li><li data-nav-id=https://docs.velociraptor.app/knowledge_base/ class="dd-item haschildren"><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/knowledge_base/><i class="fas fa-brain"></i>Knowledge Base</a></div></li><li data-nav-id=https://docs.velociraptor.app/search/ class=dd-item><div><i class="fa fa-circleXX fa-sm category-icon"></i>
<a href=/search/><i class='fas fa-search'></i>Search</a></div></li></ul><hr><section id=shortcuts><h3></h3><ul><li><a class=padding href=https://github.com/Velocidex/velociraptor><i class='fab fa-github'></i>Github</a></li><li><a class=padding href=https://docs.velociraptor.app/discord/><i class='fab fa-discord'></i>Discord</a></li><li><a class=padding href=mailto:velociraptor-discuss@googlegroups.com><i class='fas fa-envelope'></i>Mailing List</a></li><li><a class=padding href=https://docs.velociraptor.app/rss/><i class='fas fa-rss'></i>RSS</a></li></ul></section><section id=footer><div class=footer-copyright>Brought to you by
<img src=/images/Rapid7_logo.svg class=rapid7><br><i class="fas fa-copyright"></i> 2022</div></section></div></nav><script>$("#sidebar i.fa-angle-right").each(function(){$(this).parent().parent().find("ul").hide()})</script><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=top-github-link><a class=github-link title='Edit this page' href=https://github.com/Velocidex/velociraptor-docs/edit/master/content/blog/2022/2022-03-22-deaddisk/_index.md target=blank><i class="fas fa-code-branch"></i>
<span id=top-github-link-text>Edit this page</span></a></div><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links>Dead disk Forensics</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><a href=#dead-disk-analysis>Dead disk analysis</a></li><li><a href=#remapping-accessors>Remapping accessors</a></li><li><a href=#mounting-the-image>Mounting the image</a></li><li><a href=#remounting-configuration>Remounting configuration</a><ul><li><a href=#the-mount-remapping-rules>The &ldquo;mount&rdquo; remapping rules</a></li><li><a href=#remapping-the-registry-hives>Remapping the registry hives</a></li><li><a href=#remapping-currentcontrolset>Remapping CurrentControlSet</a></li><li><a href=#impersonating-an-operating-system>Impersonating an operating system</a></li></ul></li><li><a href=#analysis-of-non-windows-disk-images>Analysis of non windows disk images</a></li><li><a href=#conclusions>Conclusions</a></li></ul></nav></div></div></div></div><div id=head-tags><div class=tags><a class=tag-link href=/tags/forensics>Forensics</a>
<a class=tag-link href=/tags/vql>VQL</a></div></div><div id=body-inner><h1>Dead disk Forensics</h1><div class="author pull-right">Mike Cohen
<span class=date>2022-03-20</span></div><div class="mynotices note"><div heading=note><p>This article discusses a feature available since 0.6.4 release. This
feature is still considered experimental and we are seeking feedback
and wider testing.</p></div></div><p>Velociraptor&rsquo;s killer feature is its VQL language making it possible
to write powerful queries that triage and extract valuable forensic
evidence from the running system. One of the most attractive features
is the ability to write VQL <code>artifacts</code> encapsulating powerful VQL
queries. Users have access to a library of packaged <code>Artifacts</code> that
come with Velociraptor as well as a vibrant community and an <a href=/exchange/>Artifact
Exchange</a>.</p><p>Previously Velociraptor was most useful as a live analysis
platform. Either deployed as an agent on the live endpoint, or via the
<code>Offline Collector</code> collecting artifacts from the running
system. However, many users are sometimes faced with analyzing a dead
disk image - for example, when handed a clone of a cloud VM disk after
a compromise.</p><p>It would be really nice to be able to leverage the same VQL artifacts
developed and shared by the community on a disk image or VM clone
without having to start the VM and install Velociraptor on it.</p><h2 id=dead-disk-analysis>Dead disk analysis</h2><p>When we want to analyze a disk image we mean that:</p><ol><li>A VQL query that looks at a disk (e.g. via the <code>glob()</code> plugin),
should look inside the disk image instead of the real disk of the
analysis machine.</li><li>A VQL query that looks at system state (e.g. process listing)
should fail - otherwise we will accidentally mix results from the
analysis machine and the machine the image came from.</li></ol><p>Consider the following scenario: I have a dead disk image (In a <code>vmdk</code>
format) of a server on my analysis machine, and I want to run
Velociraptor to triage this image.</p><p>The following query retrieves all event logs from a windows system:</p><pre><code class=language-vql>SELECT OSPath
FROM glob(globs=&quot;C:/Windows/System32/WinEVT/Logs/*.evtx&quot;)
</code></pre><p>When I run this query, I want the results to come from the image and
<strong>not</strong> from my analysis machine!</p><p>Of course I can always mount my dead image on a different drive (if my
analysis machine is Windows) or a different directory (if my analysis
machine is Linux). Then I can change the query accordingly to search
for the event log files in the new location. But this is tedious and
error prone - I have to carefully change all artifacts to point to the
new drive, and if there are references in the dead image to a <code>C:</code>
drive the artifact will look for files in the <code>C:</code> drive again.</p><p>What I really want is to <strong>remap</strong> the <code>C:</code> drive to the dead image -
so whenever Velociraptor attempts to access a path beginning with <code>C:</code>
drive, the data will come from the image! This way I can use all the
artifacts as they are <strong>without modification</strong>, thereby leveraging all
my existing favorite artifacts.</p><h2 id=remapping-accessors>Remapping accessors</h2><p>Velociraptor accesses files using <a href=/docs/forensic/filesystem/#filesystem-accessors>filesystem accessors</a>. You can think
of an accessor as simply a driver that provides access to a file or
directory.</p><p>There are a number of types of accessors available, in the following
discussion the following accessors are important:</p><ul><li><p>The <strong>auto</strong> accessor is the default accessor used when an accessor
is not explicitly specified. The query <code>SELECT * FROM glob(globs='/*')</code> will use the <code>auto</code> accessor since an explicit
<code>accessor</code> parameter is not provided.</p><p>On Windows the <code>auto</code> accessor attempts to open files using the OS
API and failing this, reverts to NTFS parsing (for locked
files). This is the most commonly used accessor.</p></li><li><p>The <strong>file</strong> accessor uses the operating system APIs to open files
and directories. It is used internally by the <code>auto</code> accessor but
you can also use it explicitly.</p></li><li><p>The <strong>ntfs</strong> accessor is used to access files using the built in
NTFS parser.</p></li></ul><h2 id=mounting-the-image>Mounting the image</h2><p>The first step is to mount my dead disk image on my system so it can
be accessed by Velociraptor. Since this is a <code>vmdk</code> image, I can use
<code>vmware-mount</code> to mount a &ldquo;flat&rdquo; image easily:</p><pre><code>$ sudo vmware-mount -f /vmware/TestVM/Windows\ 10\ x64.vmdk /mnt
$ ls -l /mnt/
total 62914560
-rw------- 1 mic mic 64424509440 Jan  5 16:42 flat
</code></pre><p>The entire disk image is now available as a classic <code>dd</code> style image
within the <code>/mnt/flat</code> file.</p><h2 id=remounting-configuration>Remounting configuration</h2><p>Velociraptor normally interrogates the live machine it is running
on. However in this case we want to emulate the system under
investigation so that when Velociraptor attempts to access the system
it is really parsing the dead disk image. This process of emulation is
called <code>remapping</code> and it is controlled via remapping rules in the
configuration file.</p><p>Although I can write these rules by hand, Velociraptor offers a quick
tool that automates a lot of the remapping rule generation. Simply
point velociraptor at the mounted flat image using the
<code>--add_windows_disk</code> flag, and it will produce a new remapping yaml
config:</p><pre><code>$ velociraptor-v0.6.4-linux-amd64 -v deaddisk --add_windows_disk /mnt/flat /tmp/remapping.yaml
velociraptor: Enumerating partitions using Windows.Forensics.PartitionTable
velociraptor: Searching for a Windows directory at the top level
velociraptor: Adding windows partition at offset 122683392
velociraptor: Searching for a Windows directory at the top level
</code></pre><p>Velociraptor will enumerate the partitions in the disk image and
attempt to mount each as an NTFS partition. It will then look for a
<code>/Windows</code> directory at the top level to indicate a system drive and
map it to the <code>C:</code> drive.</p><p>You can see the full generated configuration file
<a href=https://gist.github.com/scudette/ffcd3ed2e589ebbdbe5c3edcf3914176>here</a>
but in the next few sections we will examine some remapping rules in
detail.</p><h3 id=the-mount-remapping-rules>The &ldquo;mount&rdquo; remapping rules</h3><p>Let&rsquo;s take a closer look at the following rule of type <code>mount</code></p><pre><code class=language-yaml>- type: mount
  description: 'Mount the partition /mnt/flat (offset 122683392) on the C:
    drive (NTFS)'
  from:
    accessor: raw_ntfs
    prefix: |
      {
        &quot;DelegateAccessor&quot;: &quot;offset&quot;,
        &quot;Delegate&quot;: {
          &quot;DelegateAccessor&quot;: &quot;file&quot;,
          &quot;DelegatePath&quot;: &quot;/mnt/flat&quot;,
          &quot;Path&quot;:&quot;122683392&quot;
        },
        &quot;Path&quot;: &quot;/&quot;
      }
  &quot;on&quot;:
    accessor: ntfs
    prefix: '\\.\C:'
    path_type: ntfs
</code></pre><p>A <code>mount</code> rule tells Velociraptor to map all paths below a certain
directory to a delegate accessor. When a VQL query attempts to open a
file using the <code>ntfs</code> accessor, below the <code>\\.\C:</code> directory,
Velociraptor will automatically map the request to <code>raw_ntfs</code> accessor
with the above prefix.</p><p>For example, consider the request to list the <code>\\.\C:\Windows</code>
directory. Since this directory is below the mount point of <code>\\.\C:</code>,
Velociraptor will append the remainder (the <code>Windows</code> directory) to
the mount point&rsquo;s <code>from</code> prefix and use the <code>raw_ntfs</code> accessor to
list the result.</p><p>So the following pathspec will be opened instead:</p><pre><code class=language-json>      {
        &quot;DelegateAccessor&quot;: &quot;offset&quot;,
        &quot;Delegate&quot;: {
          &quot;DelegateAccessor&quot;: &quot;file&quot;,
          &quot;DelegatePath&quot;: &quot;/mnt/flat&quot;,
          &quot;Path&quot;:&quot;122683392&quot;
        },
        &quot;Path&quot;: &quot;/Windows&quot;
      }
</code></pre><p>The prefix is an OSPath object in the form of a complete pathspec
object describing how the <code>raw_ntfs</code> accessor is to access files:</p><ol><li>The <code>raw_ntfs</code> accessor will first open it&rsquo;s delegate container and
then parse out the <code>/Windows</code> path within it.</li><li>The delegate is the <code>offset</code> accessor - an accessor that maps an
offset from it&rsquo;s own delegate (in order to extract the partition on
which the filesystem is written).</li><li>The <code>offset</code> accessor in turn uses the <code>file</code> accessor to open the
<code>/mnt/flat</code> image file. In this case the offset is 122683392 bytes
into the image.</li></ol><p>This remapping happens transparently - whenever Velociraptor accesses
the <code>ntfs</code> accessor the data will be automatically taken from the
remapped mount point.</p><p>Let&rsquo;s see how this works in practice. I will start the GUI using:</p><pre><code>$ velociraptor-v0.6.4-linux-amd64 --config_override /tmp/remapping.yaml gui -v
</code></pre><p>This simply starts the Velociraptor server and a single client talking
to it. However, due to the <code>--config_override</code> flag, the remapping
configuration will be applied to both client and server
configurations.</p><p>Now when I interact with the client&rsquo;s VFS view due to the remapping
the result comes from the <code>vmdk</code> image.</p><p><figure><img src=ntfs_accssor_vfs.png alt="Browsing the VFS with the remapped ntfs accessor" class=captioned><figcaption>Browsing the VFS with the remapped ntfs accessor</figcaption></figure></p><h3 id=remapping-the-registry-hives>Remapping the registry hives</h3><p>The above default remapping rules also include the following rule</p><pre><code class=language-yaml>- type: mount
  description: Map the /Windows/System32/Config/SOFTWARE Registry hive on HKEY_LOCAL_MACHINE\Software
  from:
    accessor: raw_reg
    prefix: |-
      {
        &quot;Path&quot;: &quot;/&quot;,
        &quot;DelegateAccessor&quot;: &quot;raw_ntfs&quot;,
        &quot;Delegate&quot;: {
          &quot;DelegateAccessor&quot;:&quot;offset&quot;,
          &quot;Delegate&quot;: {
            &quot;DelegateAccessor&quot;: &quot;file&quot;,
            &quot;DelegatePath&quot;: &quot;/mnt/flat&quot;,
            &quot;Path&quot;: &quot;122683392&quot;
          },
          &quot;Path&quot;:&quot;/Windows/System32/Config/SOFTWARE&quot;
        }
      }
    path_type: registry
  &quot;on&quot;:
    accessor: registry
    prefix: HKEY_LOCAL_MACHINE\Software
    path_type: registry
</code></pre><p>This rule mounts the <code>registry</code> accessor&rsquo;s
<code>HKEY_LOCAL_MACHINE\Software</code> path on the
<code>/Windows/System32/Config/SOFTWARE</code> file found within the raw NTFS
partition. Note how pathspec descriptors nest and can utilize
multiple different accessors to achieve the final mount point (in this
case, the <code>file</code> accessor, followed by <code>offset</code> followed by <code>raw_ntfs</code>
followed by <code>raw_registry</code>)..</p><p><figure><img src=reg_accssor_vfs.png alt="Browsing the VFS with registry accessors" class=captioned><figcaption>Browsing the VFS with registry accessors</figcaption></figure></p><p>Normally, when interacting with a live Velociraptor client, the
<code>registry</code> accessor refers to registry keys and values accessed
through the OS API. However now we were able to mount a raw registry
parser on top of the <code>registry</code> accessor.</p><div class="mynotices note"><div heading=" What does remapping achieve? "><p>By remapping the traditional accessors with emulated content, we are
effectively allowing the same VQL queries to apply to very different
scenarios <strong>without change</strong>. For example, an artifact that queries
the registry using the API will now automatically query the raw
registry parser which accesses the hive file as recovered from parsing
the ntfs filesystem on a dead disk image.</p><p>We can apply the same artifacts to the dead disk image without any
modification!</p></div></div><h3 id=remapping-currentcontrolset>Remapping CurrentControlSet</h3><p>In Windows there are virtual parts of the registry that get remounted
at runtime. One such part is the
<code>HKEY_LOCAL_MACHINE\Software\CurrentControlSet</code> key which is mounted
from <code>HKEY_LOCAL_MACHINE\Software\ControlSet001</code>. Velociraptor can recreate this mapping using the following remapping rule:</p><pre><code class=language-yaml>- type: mount
  description: Map the /Windows/System32/Config/SYSTEM Registry hive on HKEY_LOCAL_MACHINE\System\CurrentControlSet
    (Prefixed at /ControlSet001)
  from:
    accessor: raw_reg
    prefix: |-
      {
        &quot;Path&quot;: &quot;/ControlSet001&quot;,
        &quot;DelegateAccessor&quot;: &quot;raw_ntfs&quot;,
        &quot;Delegate&quot;: {
          &quot;DelegateAccessor&quot;:&quot;offset&quot;,
          &quot;Delegate&quot;: {
            &quot;DelegateAccessor&quot;: &quot;file&quot;,
            &quot;DelegatePath&quot;: &quot;/mnt/flat&quot;,
            &quot;Path&quot;: &quot;122683392&quot;
          },
          &quot;Path&quot;:&quot;/Windows/System32/Config/SYSTEM&quot;
        }
      }
    path_type: registry
  &quot;on&quot;:
    accessor: registry
    prefix: HKEY_LOCAL_MACHINE\System\CurrentControlSet
    path_type: registry
</code></pre><p>This is very important for queries that read sub-keys of <code>CurrentControlSet</code>.</p><h3 id=impersonating-an-operating-system>Impersonating an operating system</h3><p>We discussed how accessors can be remapped using the remapping rules
in order to make VQL plugins that access files emulate running on the
target system. However, many artifacts need to examine more than just
the filesystem. For example, most artifacts have a <code>precondition</code> such
as <code>SELECT * FROM info() WHERE OS =~ "Windows"</code>. If we were to run on
a Linux system these artifacts will not work since they are intended
to work on windows - despite the remapping rules emulating a Windows
system.</p><p>We therefore need to <code>impersonate</code> a windows system - even when we are
really running on a Linux machine. The impersonation rule looks like:</p><pre><code class=language-yaml>- type: impersonation
  os: windows
  hostname: VirtualHostname
  env:
  - key: SystemRoot
    value: C:\Windows
  - key: WinDir
    value: C:\Windows
  disabled_functions:
  - amsi
  - lookupSID
  - token
  disabled_plugins:
  - users
  - certificates
  - handles
  - pslist
</code></pre><p>This rule has a number of functions</p><ol><li><p>The OS type is set to Windows- This affects the output from
<code>SELECT * FROM info()</code> - this query controls most of the artifact
preconditions.</p></li><li><p>A specific hostname is set to &ldquo;VirtualHostname&rdquo;. When the client
interrogates, this hostname will appear in the Velociraptor GUI.</p></li><li><p>We specify a number of environment variables. This affects the
<code>expand()</code> function which expands paths using environment
variables. Many artifacts use environment variables to locate files
within the filesystem.</p></li><li><p>Disabled functions and plugins: Many artifacts use plugins and
functions that query non-disk system state in order to enrich the
collected data. I.e. their output does not depend just on the
disk. Using this impersonation rule we can disable those plugins
and functions (essentially return nothing from them) so the query
can complete successfully.</p></li></ol><p>Impersonation aims to make it appear that the VQL artifacts are being
collected from the target system as if it were running live.</p><p>Here is an example of collecting some common Windows artifacts from my
flat image above - running on a Linux analysis machine. We can see
some of our favorite artifacts, such as <code>Windows.Forensics.Usn</code>,
<code>Windows.Timeline.Prefetch</code>, <code>Windows.Forensics.Bam</code> and many more.</p><p><figure><img src=artifacts_prefetch.png alt="Collecting some common artifacts" class=captioned><figcaption>Collecting some common artifacts</figcaption></figure></p><h2 id=analysis-of-non-windows-disk-images>Analysis of non windows disk images</h2><p>In the previous example, we exported the <code>vmdk</code> image as a flat file
and simply relied on Velociraptor to parse the filesystem using its
inbuilt NTFS parser.</p><p>For other operating systems, Velociraptor does not currently have a
native parser (for example for Linux or MacOS). Instead, Velociraptor
relies on another tool mounting the image filesystem as a directory.</p><p>We can still perform the analysis as before however, by remapping the
mounted directory instead of a raw image.</p><p>To demonstrate this process I will mount the flat image using the
Linux loopback driver and the built in Linux NTFS filesystem support.</p><pre><code>$ sudo mount -o loop,offset=122683392 /mnt/flat /tmp/mnt/
</code></pre><p>I can now generate a second remapping configuration:</p><pre><code>$ ./velociraptor-v0.6.4-linux-amd64 deaddisk --add_windows_directory /tmp/mnt/ /tmp/remapping2.yaml
velociraptor: Adding windows mounted directory at /tmp/mnt/
velociraptor: Checking for hive at /tmp/mnt/Windows/System32/Config/SOFTWARE
velociraptor: Checking for hive at /tmp/mnt/Windows/System32/Config/SYSTEM
velociraptor: Checking for hive at /tmp/mnt/Windows/System32/Config/SYSTEM
</code></pre><p>Velociraptor will inspect the directory and determine it is a Windows
image, then attempt to map the raw registry hives at the correct place
as before. The <code>C:</code> drive remapping rule is:</p><pre><code class=language-yaml>- type: mount
  description: 'Mount the directory /tmp/mnt/ on the C: drive (NTFS)'
  from:
    accessor: file
    prefix: /tmp/mnt/
  &quot;on&quot;:
    accessor: file
    prefix: 'C:'
    path_type: windows
</code></pre><h2 id=conclusions>Conclusions</h2><p>Velociraptor is an extremely capable triage and analysis tool which
works best when running live on the endpoint - where it can correlate
information from disk, memory and volatile system state. Velociraptor
has a vibrant community with powerful user contributed artifacts
designed for use in this context.</p><p>However, sometimes we do not have the luxury of running directly on
the running endpoint, but have to rely instead on dead disk images of
the target system. The latest Velociraptor release makes it possible
to impersonate a live system based on information from the dead
disk. While this is not perfect (because a lot of the enrichment
information obtained from the live system is missing) for basic disk
focused forensic analysis, we are able to use most artifacts directly
without change.</p><p>This feature opens Velociraptor to more traditional image based
forensic analysis use cases - these users are now able to leverage the
same artifacts we all use in live triage to quickly triage dead disk
images.</p><p>Since this is such a new feature it is still considered experimental -
we value your feedback, bug reports and discussions. If you would
like to try out these features in Velociraptor, It is available on
GitHub under an open source license. As always, please file issues on
the bug tracker or ask questions on our mailing list
<a href=mailto:velociraptor-discuss@googlegroups.com>velociraptor-discuss@googlegroups.com</a>. You can also chat with us
directly on discord at <a href=https://www.velocidex.com/discord>https://www.velocidex.com/discord</a>.</p><footer class=footline></footer></div><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//velocidex-velociraptor.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><div id=navigation></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/js/clipboard.min.js?1666623087></script>
<script src=/js/perfect-scrollbar.min.js?1666623087></script>
<script src=/js/perfect-scrollbar.jquery.min.js?1666623087></script>
<script src=/js/jquery.sticky.js?1666623087></script>
<script src=/js/featherlight.min.js?1666623087></script>
<script src=/js/highlight.min.js?1666623087></script>
<script>hljs.highlightAll()</script><script src=/js/modernizr.custom-3.6.0.js?1666623087></script>
<script src=/js/learn.js?1666623087></script>
<script src=/js/hugo-learn.js?1666623087></script></body></html>